<!DOCTYPE html>
<html>
<head>
	<title>Minna Tōhyō</title>
</head>
<script src="/socket.io/socket.io.js"></script>
<script src="joinHandler.js"></script>
<script src="clientRuntime.js"></script>
<script type="text/javascript">
    function handleCountdown() {
        if (count === 0) {
            clearInterval(countdown);
            document.getElementById('countdown-text').innerHTML = 'Waiting for a response from the server...';
        } else {
            document.getElementById('countdown-text').innerHTML = count;
            count -= 1;
        }
    }
    let currentTimerCancel = false;
    let count = 3;
    let countdown;
    const socket = io();
    let player = {id: 'not-connected'};

    socket.on('connect', () => {
        socket.emit('auto-assign');
        socket.on('auto-assign-complete', isPlayer => {
            if (isPlayer) {
                const e = document.getElementById('hostButton');
                e.parentNode.removeChild(e);
                document.getElementById('connect-text').innerHTML = 'Connected. You have been selected as a player.';
            } else document.getElementById('connect-text').innerHTML = `Connected. Select playing type:`;
        });

        socket.on('players-update', players => {
            const humanList = [];
            for (let i = 0; i < players.length; i++) humanList.push(`${players[i].nickname} - ${players[i].id}`);
            document.getElementById('user-list').innerHTML = `Connected users:<br>${humanList.join('<br>')}`;
        });

        socket.on('game-start-countdown', time => {
            document.getElementById('countdown-text').style = '';
            document.getElementById('connect-text').innerHTML = `Connected with id: ${player.id} and name: ${player.nickname}`;
            //count = time / 1000;
            countdown = window.setInterval(() => {
                console.log(count);
                handleCountdown();
            }, 1000);
        });

        socket.on('game-start', gameData => {
            document.getElementById('countdown-text').innerHTML = 'Look at the host screen!';

            const elem = document.createElement('p');
            elem.setAttribute('id', 'info-text');
            elem.innerHTML = `Now playing: ${gameData.name} by: ${gameData.author}`;

            document.body.appendChild(elem);
        });

        socket.on('round-start', handleRound);
        socket.on('answer-confirm', removeUIElements);
        socket.on('vote-start', answers => handleVotingStage(answers, socket));
        socket.on('revote', handleRevote);
        socket.on('vote-end', showResults);
    });
</script>
<body>
    <div id="user-controls">
            <h1 id="connect-text">Connecting...</h1>
            <h1 id="countdown-text" style="display: none;">Game starting.</h1>
            <p id="name-text">Enter your nickname:</p><br>
            <form>
                <input type="text" id="nickname"><br>
            </form>
            <button id="hostButton" onclick="window.location.href = `${window.location.href}host/`;">Host</button>
            <button id="playerButton" onclick="sendPacketPlayer(socket, player)">Play</button>      
            <p id="user-list">No connected players</p>  
    </div>
</body>
</html>